{{- $shouldCreate := (include "perses.shouldCreateEnvVarsSecret" . | trim) }}
{{- if eq $shouldCreate "true" }}
{{- $userEnvVars := .Values.envVars | default (list) }}
{{- $autoEnvVars := list }}
{{- $usingExternalSecret := or (and .Values.secret (not (default true .Values.secret.create))) .Values.envVarsExternalSecretName }}
{{- if not $usingExternalSecret }}
{{- if .Values.config.security.enable_auth }}
{{- if .Values.config.security.authentication }}
{{- range $i, $provider := .Values.config.security.authentication.providers.oidc }}
{{- $autoEnvVars = append $autoEnvVars (dict "name" (printf "PERSES_SECURITY_AUTHENTICATION_PROVIDERS_OIDC_%d_CLIENT_ID" $i) "value" ($provider.client_id | default "")) }}
{{- $autoEnvVars = append $autoEnvVars (dict "name" (printf "PERSES_SECURITY_AUTHENTICATION_PROVIDERS_OIDC_%d_CLIENT_SECRET" $i) "value" ($provider.client_secret | default "")) }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- /* Build a map of user-provided env var names for deduplication */ -}}
{{- $userEnvNames := dict }}
{{- range $userEnvVars }}
{{- if and (kindIs "map" .) (hasKey . "name") }}
{{- $_ := set $userEnvNames .name true }}
{{- end }}
{{- end }}
{{- /* Only add auto-generated env vars if not already provided by user */ -}}
{{- $filteredAuto := list }}
{{- range $autoEnvVars }}
{{- if not (hasKey $userEnvNames .name) }}
{{- $filteredAuto = append $filteredAuto . }}
{{- end }}
{{- end }}
{{- $mergedEnvVars := concat $userEnvVars $filteredAuto }}
{{- if $mergedEnvVars }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "perses.envVarsSecretName" . }}
  labels:
    {{- include "perses.labels" . | nindent 4 }}
    app.kubernetes.io/component: configuration
  {{- with .Values.config.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
{{- range $mergedEnvVars }}
  {{- if and (kindIs "map" .) (hasKey . "value") }}
  {{ .name | kebabcase }}: {{ .value | b64enc }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
